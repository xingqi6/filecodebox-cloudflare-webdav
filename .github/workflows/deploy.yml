name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      reason:
        description: Optional note for this run
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Debug event context
        run: |
          echo "Actor: $GITHUB_ACTOR"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Reason: ${{ inputs.reason }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Wrangler
        run: npm i -g wrangler@4

      - name: Show Wrangler version
        run: wrangler --version

      - name: Validate mandatory secrets
        run: |
          missing=0
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then echo "::error::Missing secret CLOUDFLARE_API_TOKEN"; missing=1; fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then echo "::error::Missing secret CLOUDFLARE_ACCOUNT_ID"; missing=1; fi
          if [ $missing -eq 1 ]; then echo "Required secrets are missing. Configure them in Repository Settings â†’ Secrets and variables â†’ Actions."; exit 1; fi

      - name: Auto-provision KV/R2 resources
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -e
          
          # è®¾ç½®é»˜è®¤çš„ bucket åç§°
          CF_R2_BUCKET="filecodebox-storage"
          CF_R2_PREVIEW_BUCKET="filecodebox-storage-preview"

          echo "ğŸ”§ å¼€å§‹è‡ªåŠ¨é…ç½® Cloudflare èµ„æº..."
          echo "Account ID: $CLOUDFLARE_ACCOUNT_ID"

          # åˆ›å»ºæˆ–æ£€æµ‹ R2 å­˜å‚¨æ¡¶
          echo "ğŸ“¦ æ£€æŸ¥ R2 å­˜å‚¨æ¡¶..."
          if ! wrangler r2 bucket list 2>/dev/null | grep -q "^$CF_R2_BUCKET"; then
            echo "åˆ›å»º R2 å­˜å‚¨æ¡¶: $CF_R2_BUCKET"
            wrangler r2 bucket create "$CF_R2_BUCKET"
          else
            echo "âœ… R2 å­˜å‚¨æ¡¶å·²å­˜åœ¨: $CF_R2_BUCKET"
          fi

          if ! wrangler r2 bucket list 2>/dev/null | grep -q "^$CF_R2_PREVIEW_BUCKET"; then
            echo "åˆ›å»º R2 é¢„è§ˆå­˜å‚¨æ¡¶: $CF_R2_PREVIEW_BUCKET"
            wrangler r2 bucket create "$CF_R2_PREVIEW_BUCKET"
          else
            echo "âœ… R2 é¢„è§ˆå­˜å‚¨æ¡¶å·²å­˜åœ¨: $CF_R2_PREVIEW_BUCKET"
          fi

          # åˆ›å»º KV å‘½åç©ºé—´
          echo "ğŸ—„ï¸  æ£€æŸ¥ KV å‘½åç©ºé—´..."
          
          # è·å– KV namespace åˆ—è¡¨å¹¶æå– ID
          KV_LIST=$(wrangler kv namespace list 2>/dev/null || echo "")
          
          # æŸ¥æ‰¾éé¢„è§ˆçš„ FILECODEBOX_KV
          CF_KV_ID=$(echo "$KV_LIST" | grep "FILECODEBOX_KV" | grep -v "preview" | grep -oP '(?<=id = ")[^"]+' | head -1 || echo "")
          
          if [ -z "$CF_KV_ID" ]; then
            echo "åˆ›å»º KV namespace: FILECODEBOX_KV"
            KV_OUTPUT=$(wrangler kv namespace create FILECODEBOX_KV 2>&1)
            echo "$KV_OUTPUT"
            CF_KV_ID=$(echo "$KV_OUTPUT" | grep -oP '(?<=id = ")[^"]+' | head -1)
            
            if [ -z "$CF_KV_ID" ]; then
              # å°è¯•å¦ä¸€ç§æå–æ–¹å¼
              CF_KV_ID=$(echo "$KV_OUTPUT" | grep -oP '[a-f0-9]{32}' | head -1)
            fi
            
            echo "âœ… å·²åˆ›å»º KV namespace: $CF_KV_ID"
          else
            echo "âœ… æ‰¾åˆ°å·²å­˜åœ¨çš„ KV namespace: $CF_KV_ID"
          fi

          # åˆ›å»ºé¢„è§ˆ KV namespace
          CF_KV_PREVIEW_ID=$(echo "$KV_LIST" | grep "FILECODEBOX_KV" | grep "preview" | grep -oP '(?<=id = ")[^"]+' | head -1 || echo "")
          
          if [ -z "$CF_KV_PREVIEW_ID" ]; then
            echo "åˆ›å»ºé¢„è§ˆ KV namespace: FILECODEBOX_KV (preview)"
            KV_PREVIEW_OUTPUT=$(wrangler kv namespace create FILECODEBOX_KV --preview 2>&1)
            echo "$KV_PREVIEW_OUTPUT"
            CF_KV_PREVIEW_ID=$(echo "$KV_PREVIEW_OUTPUT" | grep -oP '(?<=id = ")[^"]+' | head -1)
            
            if [ -z "$CF_KV_PREVIEW_ID" ]; then
              # å°è¯•å¦ä¸€ç§æå–æ–¹å¼
              CF_KV_PREVIEW_ID=$(echo "$KV_PREVIEW_OUTPUT" | grep -oP '[a-f0-9]{32}' | head -1)
            fi
            
            echo "âœ… å·²åˆ›å»ºé¢„è§ˆ KV namespace: $CF_KV_PREVIEW_ID"
          else
            echo "âœ… æ‰¾åˆ°å·²å­˜åœ¨çš„é¢„è§ˆ KV namespace: $CF_KV_PREVIEW_ID"
          fi

          # éªŒè¯æ‰€æœ‰ ID éƒ½å·²è·å–
          if [ -z "$CF_KV_ID" ] || [ -z "$CF_KV_PREVIEW_ID" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•è·å– KV namespace ID"
            echo "KV_ID=$CF_KV_ID"
            echo "KV_PREVIEW_ID=$CF_KV_PREVIEW_ID"
            echo ""
            echo "å°è¯•é‡æ–°åˆ—å‡ºæ‰€æœ‰ KV namespaces..."
            wrangler kv namespace list
            exit 1
          fi

          echo ""
          echo "ğŸ“‹ èµ„æºé…ç½®å®Œæˆ:"
          echo "  KV ID: $CF_KV_ID"
          echo "  KV Preview ID: $CF_KV_PREVIEW_ID"
          echo "  R2 Bucket: $CF_R2_BUCKET"
          echo "  R2 Preview Bucket: $CF_R2_PREVIEW_BUCKET"

          # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CF_KV_ID=$CF_KV_ID" >> $GITHUB_ENV
          echo "CF_KV_PREVIEW_ID=$CF_KV_PREVIEW_ID" >> $GITHUB_ENV
          echo "CF_R2_BUCKET=$CF_R2_BUCKET" >> $GITHUB_ENV
          echo "CF_R2_PREVIEW_BUCKET=$CF_R2_PREVIEW_BUCKET" >> $GITHUB_ENV

      - name: ç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶æ›¿æ¢å ä½ç¬¦
        env:
          CF_KV_ID: ${{ env.CF_KV_ID }}
          CF_KV_PREVIEW_ID: ${{ env.CF_KV_PREVIEW_ID }}
          CF_R2_BUCKET: ${{ env.CF_R2_BUCKET }}
          CF_R2_PREVIEW_BUCKET: ${{ env.CF_R2_PREVIEW_BUCKET }}
        run: |
          set -e
          
          echo "ğŸ”„ æ­£åœ¨ç”Ÿæˆéƒ¨ç½²é…ç½®..."
          
          # å¤åˆ¶åŸå§‹é…ç½®
          cp wrangler.toml wrangler.gen.toml
          
          # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$CF_KV_ID" ]; then
            echo "âŒ é”™è¯¯: CF_KV_ID æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "$CF_KV_PREVIEW_ID" ]; then
            echo "âŒ é”™è¯¯: CF_KV_PREVIEW_ID æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "$CF_R2_BUCKET" ]; then
            echo "âŒ é”™è¯¯: CF_R2_BUCKET æœªè®¾ç½®"
            exit 1
          fi
          if [ -z "$CF_R2_PREVIEW_BUCKET" ]; then
            echo "âŒ é”™è¯¯: CF_R2_PREVIEW_BUCKET æœªè®¾ç½®"
            exit 1
          fi

          # æ›¿æ¢å ä½ç¬¦
          sed -i "s/REPLACE_WITH_YOUR_KV_ID/$CF_KV_ID/g" wrangler.gen.toml
          sed -i "s/REPLACE_WITH_YOUR_KV_PREVIEW_ID/$CF_KV_PREVIEW_ID/g" wrangler.gen.toml
          sed -i "s/REPLACE_WITH_YOUR_R2_BUCKET/$CF_R2_BUCKET/g" wrangler.gen.toml
          sed -i "s/REPLACE_WITH_YOUR_R2_PREVIEW_BUCKET/$CF_R2_PREVIEW_BUCKET/g" wrangler.gen.toml

          echo ""
          echo "ğŸ“„ é…ç½®æ–‡ä»¶å¯¹æ¯”:"
          diff -u wrangler.toml wrangler.gen.toml || true
          
          echo ""
          echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      - name: è®¾ç½®æ°¸ä¹…å¯†ç ï¼ˆé»˜è®¤ 123456ï¼‰
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PERMANENT_PASSWORD: ${{ secrets.PERMANENT_PASSWORD }}
        run: |
          # å¦‚æœç”¨æˆ·è®¾ç½®äº† PERMANENT_PASSWORD secretï¼Œä½¿ç”¨ç”¨æˆ·çš„å¯†ç 
          # å¦åˆ™ä½¿ç”¨é»˜è®¤å¯†ç  123456
          if [ -n "$PERMANENT_PASSWORD" ]; then
            echo "ğŸ” ä½¿ç”¨è‡ªå®šä¹‰æ°¸ä¹…å¯†ç "
            echo -n "$PERMANENT_PASSWORD" | wrangler secret put PERMANENT_PASSWORD --config wrangler.gen.toml
          else
            echo "ğŸ” ä½¿ç”¨é»˜è®¤æ°¸ä¹…å¯†ç : 123456"
            echo -n "123456" | wrangler secret put PERMANENT_PASSWORD --config wrangler.gen.toml
          fi
          echo "âœ… æ°¸ä¹…å¯†ç å·²è®¾ç½®"

      - name: éƒ¨ç½²åˆ° Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Cloudflare Workers..."
          
          if [ -f wrangler.gen.toml ]; then
            wrangler deploy --config wrangler.gen.toml
          else
            echo "âŒ é”™è¯¯: wrangler.gen.toml ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo ""
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“¦ æ‚¨çš„æ–‡ä»¶å¿«é€’æŸœå·²éƒ¨ç½²åˆ° Cloudflare Workers"
          echo "ğŸ”‘ æ°¸ä¹…ä¿å­˜åŠŸèƒ½å¯†ç : 123456 (å¯é€šè¿‡ PERMANENT_PASSWORD secret è‡ªå®šä¹‰)"
