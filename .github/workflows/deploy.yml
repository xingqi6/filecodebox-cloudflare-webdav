name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      reason:
        description: Optional note for this run
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Debug event context
        run: |
          echo "Actor: $GITHUB_ACTOR"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Reason: ${{ inputs.reason }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Wrangler
        run: npm i -g wrangler@4

      - name: Show Wrangler version
        run: wrangler --version

      - name: Validate mandatory secrets
        run: |
          missing=0
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then echo "::error::Missing secret CLOUDFLARE_API_TOKEN"; missing=1; fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then echo "::error::Missing secret CLOUDFLARE_ACCOUNT_ID"; missing=1; fi
          if [ -z "${{ secrets.WEBDAV_PASSWORD }}" ]; then echo "::error::Missing secret WEBDAV_PASSWORD"; missing=1; fi
          if [ $missing -eq 1 ]; then echo "Required secrets are missing. Configure them in Repository Settings â†’ Secrets and variables â†’ Actions."; exit 1; fi

      - name: Auto-provision KV namespace
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -e
          
          # ä¸´æ—¶é‡å‘½å wrangler.toml
          mv wrangler.toml wrangler.toml.template

          echo "ğŸ”§ å¼€å§‹è‡ªåŠ¨é…ç½® Cloudflare KV..."
          echo "Account ID: $CLOUDFLARE_ACCOUNT_ID"

          # åˆ›å»º KV å‘½åç©ºé—´
          echo "ğŸ—„ï¸  æ£€æŸ¥ KV å‘½åç©ºé—´..."
          KV_LIST=$(wrangler kv namespace list 2>/dev/null || echo "[]")
          echo "ç°æœ‰ KV namespaces:"
          echo "$KV_LIST"
          
          CF_KV_ID=$(echo "$KV_LIST" | grep -B 1 '"title": "FILECODEBOX_KV"' | grep '"id"' | head -1 | sed 's/.*"id": "\([^"]*\)".*/\1/')
          
          if [ -n "$CF_KV_ID" ]; then
            echo "âœ… æ‰¾åˆ°å·²å­˜åœ¨çš„ KV namespace: $CF_KV_ID"
          else
            echo "åˆ›å»º KV namespace: FILECODEBOX_KV"
            wrangler kv namespace create FILECODEBOX_KV 2>&1 || echo "âš ï¸  å¯èƒ½å·²å­˜åœ¨ï¼Œç»§ç»­..."
            
            sleep 2
            KV_LIST=$(wrangler kv namespace list 2>/dev/null || echo "[]")
            CF_KV_ID=$(echo "$KV_LIST" | grep -B 1 '"title": "FILECODEBOX_KV"' | grep '"id"' | head -1 | sed 's/.*"id": "\([^"]*\)".*/\1/')
          fi

          CF_KV_PREVIEW_ID=$(echo "$KV_LIST" | grep -B 1 '"title": "FILECODEBOX_KV_preview"' | grep '"id"' | head -1 | sed 's/.*"id": "\([^"]*\)".*/\1/')
          
          if [ -n "$CF_KV_PREVIEW_ID" ]; then
            echo "âœ… æ‰¾åˆ°å·²å­˜åœ¨çš„é¢„è§ˆ KV namespace: $CF_KV_PREVIEW_ID"
          else
            echo "åˆ›å»ºé¢„è§ˆ KV namespace: FILECODEBOX_KV_preview"
            wrangler kv namespace create FILECODEBOX_KV --preview 2>&1 || echo "âš ï¸  å¯èƒ½å·²å­˜åœ¨ï¼Œç»§ç»­..."
            
            sleep 2
            KV_LIST=$(wrangler kv namespace list 2>/dev/null || echo "[]")
            CF_KV_PREVIEW_ID=$(echo "$KV_LIST" | grep -B 1 '"title": "FILECODEBOX_KV_preview"' | grep '"id"' | head -1 | sed 's/.*"id": "\([^"]*\)".*/\1/')
          fi

          if [ -z "$CF_KV_ID" ] || [ -z "$CF_KV_PREVIEW_ID" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•è·å– KV namespace ID"
            echo "KV_ID='$CF_KV_ID'"
            echo "KV_PREVIEW_ID='$CF_KV_PREVIEW_ID'"
            wrangler kv namespace list
            exit 1
          fi

          echo ""
          echo "ğŸ“‹ èµ„æºé…ç½®å®Œæˆ:"
          echo "  KV ID: $CF_KV_ID"
          echo "  KV Preview ID: $CF_KV_PREVIEW_ID"

          echo "CF_KV_ID=$CF_KV_ID" >> $GITHUB_ENV
          echo "CF_KV_PREVIEW_ID=$CF_KV_PREVIEW_ID" >> $GITHUB_ENV
          
          mv wrangler.toml.template wrangler.toml

      - name: ç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶æ›¿æ¢å ä½ç¬¦
        env:
          CF_KV_ID: ${{ env.CF_KV_ID }}
          CF_KV_PREVIEW_ID: ${{ env.CF_KV_PREVIEW_ID }}
          WEBDAV_URL: ${{ vars.WEBDAV_URL || secrets.WEBDAV_URL }}
          WEBDAV_USERNAME: ${{ vars.WEBDAV_USERNAME || secrets.WEBDAV_USERNAME }}
        run: |
          set -e
          
          echo "ğŸ”„ æ­£åœ¨ç”Ÿæˆéƒ¨ç½²é…ç½®..."
          cp wrangler.toml wrangler.gen.toml
          
          # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$CF_KV_ID" ] || [ -z "$CF_KV_PREVIEW_ID" ]; then
            echo "âŒ é”™è¯¯: KV ID æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$WEBDAV_URL" ] || [ -z "$WEBDAV_USERNAME" ]; then
            echo "âŒ é”™è¯¯: WebDAV é…ç½®æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Variables:"
            echo "  - WEBDAV_URL"
            echo "  - WEBDAV_USERNAME"
            exit 1
          fi

          # æ›¿æ¢ KV å ä½ç¬¦
          sed -i "s/REPLACE_WITH_YOUR_KV_ID/$CF_KV_ID/g" wrangler.gen.toml
          sed -i "s/REPLACE_WITH_YOUR_KV_PREVIEW_ID/$CF_KV_PREVIEW_ID/g" wrangler.gen.toml
          
          # æ›¿æ¢ WebDAV å ä½ç¬¦
          sed -i "s|REPLACE_WITH_WEBDAV_URL|$WEBDAV_URL|g" wrangler.gen.toml
          sed -i "s/REPLACE_WITH_WEBDAV_USERNAME/$WEBDAV_USERNAME/g" wrangler.gen.toml

          echo ""
          echo "ğŸ“„ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ (KV éƒ¨åˆ†):"
          grep -A 3 "kv_namespaces" wrangler.gen.toml || true
          echo ""
          echo "ğŸ“„ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ (WebDAV éƒ¨åˆ†):"
          grep -A 2 "WebDAV" wrangler.gen.toml || true
          echo ""
          echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      - name: è®¾ç½® Cloudflare Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
          PERMANENT_PASSWORD: ${{ secrets.PERMANENT_PASSWORD }}
        run: |
          # è®¾ç½® WebDAV å¯†ç 
          if [ -n "$WEBDAV_PASSWORD" ]; then
            echo "ğŸ” è®¾ç½® WebDAV å¯†ç "
            echo -n "$WEBDAV_PASSWORD" | wrangler secret put WEBDAV_PASSWORD --config wrangler.gen.toml
          else
            echo "âŒ é”™è¯¯: WEBDAV_PASSWORD æœªè®¾ç½®"
            exit 1
          fi
          
          # è®¾ç½®æ°¸ä¹…å¯†ç 
          if [ -n "$PERMANENT_PASSWORD" ]; then
            echo "ğŸ” ä½¿ç”¨è‡ªå®šä¹‰æ°¸ä¹…å¯†ç "
            echo -n "$PERMANENT_PASSWORD" | wrangler secret put PERMANENT_PASSWORD --config wrangler.gen.toml
          else
            echo "ğŸ” ä½¿ç”¨é»˜è®¤æ°¸ä¹…å¯†ç : 123456"
            echo -n "123456" | wrangler secret put PERMANENT_PASSWORD --config wrangler.gen.toml
          fi
          
          echo "âœ… Secrets å·²è®¾ç½®"

      - name: éƒ¨ç½²åˆ° Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Cloudflare Workers..."
          
          if [ -f wrangler.gen.toml ]; then
            wrangler deploy --config wrangler.gen.toml
          else
            echo "âŒ é”™è¯¯: wrangler.gen.toml ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo ""
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“¦ æ‚¨çš„æ–‡ä»¶å¿«é€’æŸœå·²éƒ¨ç½²åˆ° Cloudflare Workersï¼ˆä½¿ç”¨ WebDAV å­˜å‚¨ï¼‰"
          echo "ğŸ”‘ æ°¸ä¹…ä¿å­˜åŠŸèƒ½å¯†ç : 123456 (å¯é€šè¿‡ PERMANENT_PASSWORD secret è‡ªå®šä¹‰)"
